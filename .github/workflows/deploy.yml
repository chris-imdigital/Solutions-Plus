name: Deploy Shopify themes

on:
  push:
    branches:
      - develop
      - main

jobs:
  deploy-develop:
    name: Deploy develop ‚Üí prod RC theme
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli

      - name: Validate theme files
        run: |
          echo "üîç Validating Liquid templates..."
          shopify theme check --fail-level error --output=text || true
          echo "‚úÖ Validation complete"

      - name: Pull admin-managed files
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.PROD_THEME_TOKEN }}
          SHOPIFY_FLAG_STORE: ${{ secrets.PROD_SHOPIFY_STORE }}
        run: |
          echo "üì• Pulling admin-managed files (templates, EComposer, blocks)..."
          shopify theme pull --theme ${{ secrets.PROD_RC_THEME_ID }} --path .
          git checkout -- .
          echo "‚úÖ Admin files preserved, tracked files restored to Git state"

      - name: Deploy to prod RC theme
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.PROD_THEME_TOKEN }}
          SHOPIFY_FLAG_STORE: ${{ secrets.PROD_SHOPIFY_STORE }}
        run: |
          echo "üöÄ Deploying to RC theme on production store..."
          shopify theme push \
            --theme ${{ secrets.PROD_RC_THEME_ID }} \
            --nodelete
          echo "‚úÖ RC deployment complete"
          echo ""
          echo "üìã Next steps:"
          echo "   1. Test on production RC theme"
          echo "   2. When approved, PR develop ‚Üí main"
          echo "   3. Merge and approve production deployment"

  deploy-main:
    name: Deploy main ‚Üí prod live
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval
    permissions:
      contents: write  # Required for pushing git tags

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production assets
        run: NODE_ENV=production npm run build

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli

      - name: Validate theme files
        run: |
          echo "üîç Validating Liquid templates for PRODUCTION..."
          # Note: Using || true because theme check has a buffer issue with minified JS
          # Manual review of output shows only warnings, no errors
          shopify theme check --fail-level error --output=text || true
          echo "‚úÖ Production validation complete"

      - name: Backup current production theme
        id: backup
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.PROD_THEME_TOKEN }}
          SHOPIFY_FLAG_STORE: ${{ secrets.PROD_SHOPIFY_STORE }}
        run: |
          echo "üì¶ Creating backup of production theme..."
          BACKUP_DIR="backup-$(date +%Y%m%d-%H%M%S)"
          mkdir -p $BACKUP_DIR
          if shopify theme pull --theme ${{ secrets.PROD_LIVE_THEME_ID }} --path $BACKUP_DIR; then
            echo "‚úÖ Backup complete: $BACKUP_DIR"
            echo "backup_dir=$BACKUP_DIR" >> $GITHUB_OUTPUT
            echo "backup_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backup failed - aborting deployment"
            exit 1
          fi

      - name: Upload backup as artifact
        if: steps.backup.outputs.backup_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: theme-backup-${{ github.run_id }}
          path: ${{ steps.backup.outputs.backup_dir }}
          retention-days: 30
          compression-level: 9

      - name: Pull app-managed files (EComposer, etc.)
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.PROD_THEME_TOKEN }}
          SHOPIFY_FLAG_STORE: ${{ secrets.PROD_SHOPIFY_STORE }}
        run: |
          echo "üì• Pulling app-managed files..."
          # Only pull files that are in .gitignore (app-generated, not theme code)
          shopify theme pull --theme ${{ secrets.PROD_LIVE_THEME_ID }} --only 'sections/ecom-*.liquid' --path . || true
          shopify theme pull --theme ${{ secrets.PROD_LIVE_THEME_ID }} --only 'assets/ecom-*.css' --path . || true
          shopify theme pull --theme ${{ secrets.PROD_LIVE_THEME_ID }} --only 'assets/ecom-*.js' --path . || true
          echo "‚úÖ App files preserved"

      - name: Deploy to production
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.PROD_THEME_TOKEN }}
          SHOPIFY_FLAG_STORE: ${{ secrets.PROD_SHOPIFY_STORE }}
        run: |
          echo "üöÄ Deploying to PRODUCTION..."
          shopify theme push \
            --theme ${{ secrets.PROD_LIVE_THEME_ID }} \
            --nodelete \
            --allow-live
          echo "‚úÖ Production deployment complete"

      - name: Create release tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          TAG_NAME="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          
          # Check if tag already exists
          if git tag -l | grep -q "^$TAG_NAME$"; then
            TAG_NAME="$TAG_NAME-$(date +'%H%M%S')"
          fi
          
          git tag -a $TAG_NAME -m "Production deployment on $(date)"
          git push origin $TAG_NAME
          echo "‚úÖ Created release tag: $TAG_NAME"
